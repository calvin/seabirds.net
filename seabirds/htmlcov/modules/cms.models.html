<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8" />
    <title>Test coverage report: cms.models</title>
    <style type="text/css" media="screen">
      a
      {
        color: #3d707a;
      }
      
      a:hover, a:active
      {
        color: #bf7d18;
      }
    
      body 
      {
        font-family: "Lucida Sans Unicode", "Lucida Grande", sans-serif;
        font-size: 13px;
      }
      
      .nav 
      {
        font-size: 12px;
        margin-left: 50px;
      }

      .ignored
      {
        color: #707070;
      }

      .executed 
      {
        color: #3d9900;
      }

      .missed 
      {
        color: red;
        font-weight: bold;
      }

      .excluded 
      {
        color: #6090f0;
        font-weight: lighter;
      }
    
      #content-header 
      {
        font-size: 12px;
        padding: 18px 0 18px 50px;
      }

      #content-header h1 
      {
        font-size: 16px;
        margin: 10px 0 0 0;
        color: #909090;
      }
      
      #module-name
      {
        color: #583707;
      }
    
      #content-header p
      {
        font-size: 13px;
        margin: 0;
        color: #909090;
      }

      #content-header .normal 
      {
        color: #609030;
      }

      #content-header .warning 
      {
        color: #d0a000;
      }

      #content-header .critical 
      {
        color: red;
      }
      
      #source-listing 
      {
        margin-bottom: 24px;
      }

      #source-listing ol 
      {
        padding: 0 0 0 50px;
        width: 90%;
        font-family: monospace;
        list-style-position: outside;
      }

      #source-listing ol li 
      {
        line-height: 18px;
        font-size: small;
      }
        
      #source-listing ol code 
      {
        padding:  0 .001em 0 0; /* Firefox doesn't render empty li's properly */
        font-size: medium;
        white-space: pre;
      }
   </style>
  </head>

  <body>

<div class="nav">
  <a href="cms.forms.html">cms.forms</a> &lt;&lt;
  <a href="../index.html">index</a>
  &gt;&gt; <a href="cms.views.html">cms.views</a>
</div>

<div id="content-header">
  <h1>
    <span id="module-name">cms.models</span>:
    194 total statements,
    <span class="critical">42.9% covered</span>
  </h1>
  <p>Generated: Wed 2012-02-15 21:19 NZDT</p>
  <p>Source file: /home/edward/seabirds.net/seabirds/cms/models.py</p>
  <p>
    Stats:
    <span class="executed">72 executed</span>,
    <span class="missed">96 missed</span>,
    <span class="excluded">26 excluded</span>,
    <span class="ignored">79 ignored</span> 
  </p> 
</div>

<div id="source-listing">
  <ol>
    <li class="excluded"><code>import re</code></li>
<li class="excluded"><code>import logging</code></li>
<li class="excluded"><code>import os</code></li>
<li class="excluded"><code>from math import floor</code></li>
<li class="ignored"><code></code></li>
<li class="excluded"><code>from django.db import models</code></li>
<li class="excluded"><code>from django.db.models import permalink</code></li>
<li class="excluded"><code>from django.conf import settings</code></li>
<li class="excluded"><code>from django.contrib.auth.models import User</code></li>
<li class="excluded"><code>from django.template.loader import render_to_string</code></li>
<li class="excluded"><code>from django.core.exceptions import ValidationError</code></li>
<li class="excluded"><code>from django.core.urlresolvers import resolve, Resolver404</code></li>
<li class="ignored"><code></code></li>
<li class="excluded"><code>from markdown import markdown</code></li>
<li class="excluded"><code>from mptt.models import MPTTModel, TreeForeignKey</code></li>
<li class="ignored"><code></code></li>
<li class="excluded"><code>from license.models import License</code></li>
<li class="excluded"><code>from categories.models import SeabirdFamily</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code># Process references if the bibliography is installed</code></li>
<li class="executed"><code>try:</code></li>
<li class="excluded"><code>    from bibliography.views import markdown_post_references</code></li>
<li class="missed"><code>except ImportError:</code></li>
<li class="missed"><code>    def markdown_post_references(text):</code></li>
<li class="missed"><code>        return text</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>check=True</code></li>
<li class="executed"><code>IMAGE_REGEX = '\[Image\s+([-\w]+)(\s+\w[\w=%\'" -]+)?\s*\](.*)(?=&lt;/p&gt;)'</code></li>
<li class="executed"><code>def markdownplus(instance, text, check=False):</code></li>
<li class="missed"><code>    text = markdown(text)</code></li>
<li class="missed"><code>    def insert_image(m):</code></li>
<li class="missed"><code>        try:</code></li>
<li class="missed"><code>            image = Image.objects.get(key=m.group(1))</code></li>
<li class="missed"><code>            try:</code></li>
<li class="missed"><code>                width = int(re.findall('width=([\d]+)', m.group(2))[0])</code></li>
<li class="missed"><code>            except:</code></li>
<li class="missed"><code>                width = None</code></li>
<li class="missed"><code>            try:</code></li>
<li class="missed"><code>                height = int(re.findall('height=([\d]+)', m.group(2))[0])</code></li>
<li class="missed"><code>            except:</code></li>
<li class="missed"><code>                height = None</code></li>
<li class="missed"><code>            try:</code></li>
<li class="missed"><code>                place = re.findall('place=([\w]+)', m.group(2))[0]</code></li>
<li class="missed"><code>            except:</code></li>
<li class="missed"><code>                place = ''</code></li>
<li class="missed"><code>            width, height = image.get_dimensions(width, height)</code></li>
<li class="missed"><code>            url = image.get_qualified_url(width, height)</code></li>
<li class="missed"><code>            if place.upper().startswith('R'):</code></li>
<li class="missed"><code>                place = 'float-right'</code></li>
<li class="missed"><code>            elif place.upper().startswith('L'):</code></li>
<li class="missed"><code>                place = 'float-left'</code></li>
<li class="ignored"><code>            else:</code></li>
<li class="missed"><code>                place = 'center'</code></li>
<li class="missed"><code>            caption = m.group(3)</code></li>
<li class="missed"><code>            if not caption:</code></li>
<li class="missed"><code>                caption = image.caption</code></li>
<li class="missed"><code>            return render_to_string('image/plain.html', dict(image=image, width=width, place=place, url=url, caption=caption))</code></li>
<li class="missed"><code>        except:</code></li>
<li class="missed"><code>            if check:</code></li>
<li class="missed"><code>                raise</code></li>
<li class="missed"><code>            return m.group(0)</code></li>
<li class="missed"><code>    text = re.sub(IMAGE_REGEX, insert_image,  text)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def insert_references(m):</code></li>
<li class="missed"><code>        try:</code></li>
<li class="missed"><code>            return listview(None, query=m.group(1))</code></li>
<li class="missed"><code>        except:</code></li>
<li class="missed"><code>            if check: raise</code></li>
<li class="missed"><code>            return ""</code></li>
<li class="missed"><code>    text = re.sub('\[References\s+(\w[\w=\'" -]+)\]', insert_references,  text)</code></li>
<li class="missed"><code>    return text</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    def insert_file(m):</code></li>
<li class="missed"><code>        try:</code></li>
<li class="missed"><code>            file = File.objects.get(name=m.group(1))</code></li>
<li class="missed"><code>            return file.html()</code></li>
<li class="missed"><code>        except:</code></li>
<li class="missed"><code>            if check: raise</code></li>
<li class="missed"><code>            return ""</code></li>
<li class="missed"><code>    text = re.sub('\[File\s+(\w+)\]',   insert_file, text)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    text = markdown_post_references(text)</code></li>
<li class="missed"><code>    return text</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code># Create your models here.</code></li>
<li class="executed"><code>class Page(models.Model):</code></li>
<li class="executed"><code>    title = models.CharField(max_length = 100,</code></li>
<li class="ignored"><code>        help_text='Title of the page, appears in the title bar of the browser')</code></li>
<li class="executed"><code>    name = models.SlugField(max_length = 50, unique = True,</code></li>
<li class="ignored"><code>        help_text = 'The name of the page. Pages are referenced as "%s/{name}.html". The field name can only contain alphanumeric characters, dashes, and underscores.'%settings.SITE_URL)</code></li>
<li class="executed"><code>    parent = models.ForeignKey('self', null=True, blank=True, related_name='children',</code></li>
<li class="ignored"><code>        help_text='Set the parent page. Used to define a page hierarchy across the site')</code></li>
<li class="executed"><code>    published = models.BooleanField(default=False,</code></li>
<li class="ignored"><code>        help_text='Page will appear on the site when this field is ticked')</code></li>
<li class="executed"><code>    text = models.TextField(null=True, blank=True,</code></li>
<li class="ignored"><code>        help_text='Page text. Formatted using &lt;a href="http://daringfireball.net/projects/markdown/syntax"&gt;markdown&lt;/a&gt;')</code></li>
<li class="executed"><code>    sidebar = models.TextField(null=True, blank=True,</code></li>
<li class="ignored"><code>        help_text='Sidebar text. Appears at the top of the right sidebar. Formatted using &lt;a href="http://daringfireball.net/projects/markdown/syntax"&gt;markdown&lt;/a&gt;')</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>    def __str__(self):</code></li>
<li class="missed"><code>        return self.name</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>    @property</code></li>
<li class="ignored"><code>    def markdown_text(self):</code></li>
<li class="missed"><code>        return markdownplus(self, self.text)</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>    @property</code></li>
<li class="ignored"><code>    def markdown_sidebar(self):</code></li>
<li class="missed"><code>        return markdownplus(self, self.sidebar)</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>    @permalink</code></li>
<li class="excluded"><code>    def get_absolute_url(self):</code></li>
<li class="excluded"><code>        return ('cms.views.page', (), {'name': self.name})</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>class Post(models.Model):</code></li>
<li class="executed"><code>    title = models.CharField(max_length = 100,</code></li>
<li class="ignored"><code>        help_text="Title of the post")</code></li>
<li class="executed"><code>    name = models.SlugField(max_length = 50, unique = True,</code></li>
<li class="ignored"><code>        help_text="Name used to refer to the post in the URL. Must be only letters, numbers, underscores, or hyphens.")</code></li>
<li class="executed"><code>    author = models.ForeignKey(User, null=True, blank=True,</code></li>
<li class="ignored"><code>        help_text="Optional. User who made the post, leave blank for anonymous posts.")</code></li>
<li class="executed"><code>    date_published = models.DateField(</code></li>
<li class="ignored"><code>        help_text="Publication date")</code></li>
<li class="executed"><code>    published = models.BooleanField(default=False,</code></li>
<li class="ignored"><code>        help_text="When this box is checked, the post will be visible on the site.")</code></li>
<li class="executed"><code>    retracted = models.BooleanField(default=False,</code></li>
<li class="ignored"><code>        help_text="Check this box to retract this post")</code></li>
<li class="executed"><code>    teaser = models.TextField(max_length = 300,</code></li>
<li class="ignored"><code>        help_text='Teaser text. Short text that appears in lists of posts. Must be less than 300 characters long. Formatted using &lt;a href="http://daringfireball.net/projects/markdown/syntax"&gt;markdown&lt;/a&gt;')</code></li>
<li class="executed"><code>    text = models.TextField(</code></li>
<li class="ignored"><code>        help_text='Post text. Formatted using &lt;a href="http://daringfireball.net/projects/markdown/syntax"&gt;markdown&lt;/a&gt;')</code></li>
<li class="executed"><code>    seabird_families = models.ManyToManyField(SeabirdFamily, related_name='posts', null=True, blank=True, help_text="Optional. If this post is about a particular seabird or seabirds, please select the correct families.")</code></li>
<li class="executed"><code>    image = models.ForeignKey('Image', related_name = 'posts', null=True, blank=True,</code></li>
<li class="ignored"><code>	    help_text='Image associated with the post')</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>    def __str__(self):</code></li>
<li class="missed"><code>        return self.name</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>    @property</code></li>
<li class="ignored"><code>    def markdown_text(self):</code></li>
<li class="missed"><code>        return markdownplus(self, self.text)</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>    @property</code></li>
<li class="ignored"><code>    def markdown_teaser(self):</code></li>
<li class="missed"><code>        return markdownplus(self, self.teaser)</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>    @permalink</code></li>
<li class="excluded"><code>    def get_absolute_url(self):</code></li>
<li class="excluded"><code>        return ('individual-post', (), {</code></li>
<li class="ignored"><code>            'year': self.date_published.year,</code></li>
<li class="ignored"><code>            'month': self.date_published.strftime('%m'),</code></li>
<li class="ignored"><code>            'day': self.date_published.strftime('%d'),</code></li>
<li class="ignored"><code>            'slug': self.name})</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>    class Meta:</code></li>
<li class="executed"><code>        ordering = ['-date_published']</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>class File(models.Model):</code></li>
<li class="executed"><code>   name = models.CharField(max_length = 100)</code></li>
<li class="executed"><code>   file = models.FileField(upload_to = "files")</code></li>
<li class="executed"><code>   title = models.CharField(max_length = 100, null=True, blank=True)</code></li>
<li class="executed"><code>   def __str__(self):</code></li>
<li class="missed"><code>      return self.title</code></li>
<li class="excluded"><code>   def get_absolute_url(self):</code></li>
<li class="excluded"><code>      return  "%s/%s" % (settings.SITE_URL, self.file.url)</code></li>
<li class="executed"><code>   def html(self):</code></li>
<li class="missed"><code>      return "&lt;a href=\"%s/%s\"&gt;%s&lt;/a&gt;" % (settings.SITE_URL, self.file.url, self.title)</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>def get_image_path(instance, filename):</code></li>
<li class="missed"><code>    print 'get path'</code></li>
<li class="missed"><code>    base, ext = os.path.splitext(os.path.split(filename)[1])</code></li>
<li class="missed"><code>    return os.path.join('images', '%s%s'%(instance.key, ext))</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>class Image(models.Model):</code></li>
<li class="executed"><code>    image = models.ImageField(upload_to = get_image_path)</code></li>
<li class="executed"><code>    title = models.CharField(max_length = 100,</code></li>
<li class="ignored"><code>        help_text="The title is displayed when you mouse over the image")</code></li>
<li class="executed"><code>    source_url = models.URLField(null=True, blank=True, verify_exists = not settings.DEBUG,</code></li>
<li class="ignored"><code>        help_text="Optional. A url used to link to the original image (e.g. http://www.flickr.com/picture.png).")</code></li>
<li class="executed"><code>    caption = models.TextField(null=True, blank=True,</code></li>
<li class="ignored"><code>        help_text="Optional. Displayed under the image.")</code></li>
<li class="executed"><code>    key = models.SlugField(max_length = 50, unique=True,</code></li>
<li class="ignored"><code>        help_text="A unique name for each image on the website. Must only be letters, number, underscores, or hyphens.")</code></li>
<li class="executed"><code>    seabird_families = models.ManyToManyField(SeabirdFamily, related_name='images', null=True, blank=True, help_text="Optional. If this is an image of a seabird or seabirds, please select the correct families.")</code></li>
<li class="executed"><code>    owner = models.CharField(max_length = 200,</code></li>
<li class="ignored"><code>        help_text="The name of the copyright holder of the image")</code></li>
<li class="executed"><code>    owner_url = models.URLField(null=True, blank=True, verify_exists = not settings.DEBUG,</code></li>
<li class="ignored"><code>        help_text="Optional. A url linking to a website giving more information on the copyright owner (e.g., http://www.people.com/mr-nice.html)")</code></li>
<li class="executed"><code>    license = models.ForeignKey(License, null=True, blank=True,</code></li>
<li class="ignored"><code>        help_text="Optional copyright license. Available licenses include &lt;a href='http://creativecommons.org/'&gt;creative commons&lt;/a&gt; or public domain licenses. If no license is specified it is assumed that the owner has the copyright and has granted permission for the image to be used")</code></li>
<li class="executed"><code>    uploaded_by = models.ForeignKey(User,</code></li>
<li class="ignored"><code>        help_text="The user who uploaded the image")</code></li>
<li class="executed"><code>    date_created = models.DateField(auto_now_add=True)</code></li>
<li class="executed"><code>    date_modified = models.DateField(auto_now=True)</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>    def thumbnail(self, width=100, max_height=300):</code></li>
<li class="missed"><code>        width, height = self.get_dimensions(width=width, max_height=max_height)</code></li>
<li class="missed"><code>        return "&lt;img src='/%s' title='%s'&gt;"%(self.get_qualified_url(width, height), self.title)</code></li>
<li class="executed"><code>    thumbnail.allow_tags=True</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>    def render(self, width=None, height=None, caption=None, place=None):</code></li>
<li class="missed"><code>        width, height = self.get_dimensions(widt=width, height=height)</code></li>
<li class="missed"><code>        url = self.get_qualified_url(width, height)</code></li>
<li class="missed"><code>        if not caption:</code></li>
<li class="missed"><code>            caption=self.caption</code></li>
<li class="missed"><code>        return render_to_string('image/plain.html', dict(image=image, width=width, place=None, url=url, caption=caption))</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>    def tag(self):</code></li>
<li class="missed"><code>        return "[Image %s]"%(self.key,)</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>    def __str__(self):</code></li>
<li class="missed"><code>        return '%s - %s'%(self.key, self.title)</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>    def get_dimensions(self, width=None, height=None, max_height=None):</code></li>
<li class="missed"><code>        if not height and not width:</code></li>
<li class="missed"><code>            height = self.image.height</code></li>
<li class="missed"><code>            width = self.image.width</code></li>
<li class="missed"><code>        elif not height:</code></li>
<li class="missed"><code>            height = int(float(self.image.height*width)/self.image.width)</code></li>
<li class="missed"><code>        elif not width:</code></li>
<li class="missed"><code>            width = int(float(self.image.width*height)/self.image.height)</code></li>
<li class="missed"><code>        if max_height and height &gt; max_height:</code></li>
<li class="missed"><code>            height = max_height</code></li>
<li class="missed"><code>            width = int(float(width*height)/max_height)</code></li>
<li class="missed"><code>        return width, height</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>    def get_qualified_url(self, width=None, height=None, max_height=None):</code></li>
<li class="missed"><code>	if not width or not height or max_height:</code></li>
<li class="missed"><code>	    width, height = self.get_dimensions(width=width, height=height, max_height=max_height)</code></li>
<li class="missed"><code>        base, ext = os.path.splitext(os.path.split(self.image.path)[1])</code></li>
<li class="missed"><code>        return os.path.join('images', '%s-%ix%i%s'%(base, width, height, ext))</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>    @permalink</code></li>
<li class="ignored"><code>    def get_image_url(self):</code></li>
<li class="missed"><code>        return ('cms.views.image', (), {'filename': os.path.split(self.image.path)[1]})</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>    @permalink</code></li>
<li class="excluded"><code>    def get_absolute_url(self):</code></li>
<li class="excluded"><code>        return ('cms.views.imagepage', (), {'key': self.key})</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>class Navigation(MPTTModel):</code></li>
<li class="executed"><code>    name = models.CharField(max_length=20,</code></li>
<li class="ignored"><code>        help_text="Text that appears in the navigation menu")</code></li>
<li class="executed"><code>    url = models.CharField(max_length = 100,</code></li>
<li class="ignored"><code>        help_text="URL of the link (e.g. '/home.html')")</code></li>
<li class="executed"><code>    title = models.CharField(max_length = 100,</code></li>
<li class="ignored"><code>        help_text="Text that appears when you mouse over the menu item")</code></li>
<li class="executed"><code>    order = models.PositiveIntegerField(</code></li>
<li class="ignored"><code>        help_text="Order of the items in the fully expanded menu (a postive integer)")</code></li>
<li class="executed"><code>    parent = TreeForeignKey('self', null=True, blank=True, related_name='children',</code></li>
<li class="ignored"><code>        help_text="Parent navigation item, used to define the navigation hierarchy")</code></li>
<li class="ignored"><code></code></li>
<li class="excluded"><code>    def __unicode__(self):</code></li>
<li class="excluded"><code>        return self.name</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>    def clean(self):</code></li>
<li class="missed"><code>        if not self.url.startswith('/'):</code></li>
<li class="missed"><code>            self.url = '/'+self.url</code></li>
<li class="missed"><code>        try:</code></li>
<li class="missed"><code>            resolve(self.url)</code></li>
<li class="missed"><code>        except Resolver404:</code></li>
<li class="missed"><code>            message = 'Unknown URL %s' % self.url</code></li>
<li class="missed"><code>            raise ValidationError, message</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>    class MPTTMeta:</code></li>
<li class="executed"><code>        order_insertion_by = ['order']</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>    class Meta:</code></li>
<li class="executed"><code>        verbose_name_plural = 'navigation'</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
  </ol>
</div>

<div class="nav">
  <a href="cms.forms.html">cms.forms</a> &lt;&lt;
  <a href="../index.html">index</a>
  &gt;&gt; <a href="cms.views.html">cms.views</a>
</div>

  </body>
</html>

