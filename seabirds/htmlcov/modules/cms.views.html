<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-type" content="text/html;charset=UTF-8" />
    <title>Test coverage report: cms.views</title>
    <style type="text/css" media="screen">
      a
      {
        color: #3d707a;
      }
      
      a:hover, a:active
      {
        color: #bf7d18;
      }
    
      body 
      {
        font-family: "Lucida Sans Unicode", "Lucida Grande", sans-serif;
        font-size: 13px;
      }
      
      .nav 
      {
        font-size: 12px;
        margin-left: 50px;
      }

      .ignored
      {
        color: #707070;
      }

      .executed 
      {
        color: #3d9900;
      }

      .missed 
      {
        color: red;
        font-weight: bold;
      }

      .excluded 
      {
        color: #6090f0;
        font-weight: lighter;
      }
    
      #content-header 
      {
        font-size: 12px;
        padding: 18px 0 18px 50px;
      }

      #content-header h1 
      {
        font-size: 16px;
        margin: 10px 0 0 0;
        color: #909090;
      }
      
      #module-name
      {
        color: #583707;
      }
    
      #content-header p
      {
        font-size: 13px;
        margin: 0;
        color: #909090;
      }

      #content-header .normal 
      {
        color: #609030;
      }

      #content-header .warning 
      {
        color: #d0a000;
      }

      #content-header .critical 
      {
        color: red;
      }
      
      #source-listing 
      {
        margin-bottom: 24px;
      }

      #source-listing ol 
      {
        padding: 0 0 0 50px;
        width: 90%;
        font-family: monospace;
        list-style-position: outside;
      }

      #source-listing ol li 
      {
        line-height: 18px;
        font-size: small;
      }
        
      #source-listing ol code 
      {
        padding:  0 .001em 0 0; /* Firefox doesn't render empty li's properly */
        font-size: medium;
        white-space: pre;
      }
   </style>
  </head>

  <body>

<div class="nav">
  <a href="cms.models.html">cms.models</a> &lt;&lt;
  <a href="../index.html">index</a>
</div>

<div id="content-header">
  <h1>
    <span id="module-name">cms.views</span>:
    182 total statements,
    <span class="critical">10.5% covered</span>
  </h1>
  <p>Generated: Wed 2012-02-15 21:19 NZDT</p>
  <p>Source file: /home/edward/seabirds.net/seabirds/cms/views.py</p>
  <p>
    Stats:
    <span class="executed">17 executed</span>,
    <span class="missed">145 missed</span>,
    <span class="excluded">20 excluded</span>,
    <span class="ignored">63 ignored</span> 
  </p> 
</div>

<div id="source-listing">
  <ol>
    <li class="excluded"><code>import datetime</code></li>
<li class="excluded"><code>import types</code></li>
<li class="excluded"><code>import os</code></li>
<li class="excluded"><code>import re</code></li>
<li class="excluded"><code>import logging</code></li>
<li class="ignored"><code></code></li>
<li class="excluded"><code>from django.http import Http404, HttpResponseRedirect, HttpResponse</code></li>
<li class="excluded"><code>from django.shortcuts import get_object_or_404, render_to_response, get_list_or_404</code></li>
<li class="excluded"><code>from django.template import RequestContext</code></li>
<li class="excluded"><code>from django.conf import settings</code></li>
<li class="excluded"><code>from django.views.static import serve</code></li>
<li class="excluded"><code>from django.conf import settings</code></li>
<li class="excluded"><code>from django.core.urlresolvers import reverse</code></li>
<li class="excluded"><code>from django.contrib.auth.decorators import login_required</code></li>
<li class="excluded"><code>from django.template.defaultfilters import slugify</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="excluded"><code>from PIL import Image as PILImage</code></li>
<li class="ignored"><code></code></li>
<li class="excluded"><code>from cms.models import Page, File, Navigation, Image, Post</code></li>
<li class="excluded"><code>from cms.forms import PostForm, ImageForm</code></li>
<li class="excluded"><code>from bibliography.models import Reference</code></li>
<li class="excluded"><code>from license.models import License</code></li>
<li class="excluded"><code>from profile.models import UserProfile</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>@login_required</code></li>
<li class="ignored"><code>def page(request, name):</code></li>
<li class="missed"><code>    context_instance=RequestContext(request)</code></li>
<li class="missed"><code>    context_instance.autoescape=False</code></li>
<li class="missed"><code>    if name == 'index':</code></li>
<li class="missed"><code>        name = 'home'</code></li>
<li class="missed"><code>        fullpath = ""</code></li>
<li class="ignored"><code>    else:</code></li>
<li class="missed"><code>        fullpath = name</code></li>
<li class="missed"><code>    name = os.path.basename(name)</code></li>
<li class="missed"><code>    page =  get_object_or_404(Page, name = name)</code></li>
<li class="missed"><code>    navigation = page.get_absolute_url()</code></li>
<li class="missed"><code>    level = page</code></li>
<li class="missed"><code>    while level.parent:</code></li>
<li class="missed"><code>        if Navigation.objects.filter(url = navigation):</code></li>
<li class="missed"><code>            break</code></li>
<li class="missed"><code>        level = level.parent</code></li>
<li class="missed"><code>        navigation = level.get_absolute_url()</code></li>
<li class="missed"><code>    c = dict(</code></li>
<li class="ignored"><code>            page = page,</code></li>
<li class="ignored"><code>            navigation = get_navigation(navigation),</code></li>
<li class="ignored"><code>            )</code></li>
<li class="missed"><code>    return render_to_response('index.html', c, context_instance)</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>@login_required</code></li>
<li class="ignored"><code>def home(request):</code></li>
<li class="missed"><code>    return page(request, 'home')</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>#def people(request):</code></li>
<li class="ignored"><code>#    persons = Person.objects.all().order_by('order')</code></li>
<li class="ignored"><code>#    page = Page.objects.get(name = 'people')</code></li>
<li class="ignored"><code>#    return render_to_response('people.html', dict(person_list=persons, page=page, navigation=get_navigation('/people.html')),</code></li>
<li class="ignored"><code>#        RequestContext(request))</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>def image(request, filename):</code></li>
<li class="ignored"><code>    #Return the file if it is in the  images directory</code></li>
<li class="missed"><code>    if os.path.exists(os.path.join(settings.MEDIA_ROOT, 'images', filename)):</code></li>
<li class="missed"><code>        return serve(request, filename, document_root=os.path.join(settings.MEDIA_ROOT, 'images'))</code></li>
<li class="ignored"><code>    #If not then look for it in the  cache directory</code></li>
<li class="missed"><code>    path = os.path.join(settings.MEDIA_ROOT, 'images', 'cache', filename)</code></li>
<li class="missed"><code>    if os.path.exists(path):</code></li>
<li class="missed"><code>        return serve(request, filename, document_root=os.path.join(settings.MEDIA_ROOT, 'images', 'cache'))</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code>    # If it  isn't their, then make the image</code></li>
<li class="ignored"><code>    # look for an image that is the same without size info</code></li>
<li class="missed"><code>    m = re.search('-(\d+)x(\d+)', filename)</code></li>
<li class="missed"><code>    if not m: raise Http404</code></li>
<li class="missed"><code>    origname = re.sub('-\d+x\d+', '', filename)</code></li>
<li class="missed"><code>    origpath = os.path.join(settings.MEDIA_ROOT, 'images', origname)</code></li>
<li class="missed"><code>    if not os.path.exists(origpath): raise Http404</code></li>
<li class="missed"><code>    orig = PILImage.open(origpath)</code></li>
<li class="missed"><code>    format = orig.format</code></li>
<li class="missed"><code>    (basewidth, baseheight) = (int(m.group(1)), int(m.group(2)))</code></li>
<li class="missed"><code>    wpercent = (basewidth/float(orig.size[0]))</code></li>
<li class="missed"><code>    hsize = int((float(orig.size[1])*float(wpercent)))</code></li>
<li class="missed"><code>    img = orig.convert('RGB').resize((basewidth, hsize), PILImage.ANTIALIAS)</code></li>
<li class="missed"><code>    img.save(path, format)</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    response = HttpResponse(mimetype="image/%s"%(format))</code></li>
<li class="missed"><code>    img.save(response, format)</code></li>
<li class="missed"><code>    return response</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>@login_required</code></li>
<li class="ignored"><code>def imagepage(request, key):</code></li>
<li class="missed"><code>    image = get_object_or_404(Image, key=key)</code></li>
<li class="missed"><code>    return render_to_response('cms/imagepage.html', {'image': image})</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>@login_required</code></li>
<li class="ignored"><code>def reference(request, key):</code></li>
<li class="missed"><code>    current = None</code></li>
<li class="missed"><code>    for r in get_list_or_404(Reference, name=key):</code></li>
<li class="missed"><code>        current = r</code></li>
<li class="missed"><code>    return render_to_response('references/view.html', dict(</code></li>
<li class="ignored"><code>            current = current, page = dict(title=current.title),</code></li>
<li class="ignored"><code>            navigation = get_navigation('/publications.html'),</code></li>
<li class="ignored"><code>        ), RequestContext(request))</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>def get_navigation(url):</code></li>
<li class="missed"><code>    try:</code></li>
<li class="missed"><code>        home = Navigation.objects.root_nodes()[0]</code></li>
<li class="missed"><code>    except IndexError:</code></li>
<li class="missed"><code>        return []</code></li>
<li class="missed"><code>    try:</code></li>
<li class="missed"><code>        node = Navigation.objects.get(url=url)</code></li>
<li class="missed"><code>    except:</code></li>
<li class="missed"><code>        node = home</code></li>
<li class="missed"><code>    actives = [node] + list(node.get_ancestors())</code></li>
<li class="missed"><code>    links = []</code></li>
<li class="missed"><code>    for child in home.get_children():</code></li>
<li class="missed"><code>        if child == node:</code></li>
<li class="missed"><code>            grandchildren = child.get_children()</code></li>
<li class="missed"><code>            sublinks = [(g, False, []) for g in grandchildren]</code></li>
<li class="missed"><code>            links.append((child, True, sublinks))</code></li>
<li class="missed"><code>        elif child in actives:</code></li>
<li class="missed"><code>            grandchildren = child.get_children()</code></li>
<li class="missed"><code>            sublinks = []</code></li>
<li class="missed"><code>            for g in grandchildren:</code></li>
<li class="missed"><code>                if g in actives:</code></li>
<li class="missed"><code>                    sublinks.append((g, True, []))</code></li>
<li class="ignored"><code>                else:</code></li>
<li class="missed"><code>                    sublinks.append((g, False, []))</code></li>
<li class="missed"><code>            links.append((child, False, sublinks))</code></li>
<li class="ignored"><code>        else:</code></li>
<li class="missed"><code>            links.append((child, False, []))</code></li>
<li class="missed"><code>    return links</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>def get_base_navigation(request):</code></li>
<li class="executed"><code>    try:</code></li>
<li class="executed"><code>        root = Navigation.objects.root_nodes()[0]</code></li>
<li class="executed"><code>    except IndexError:</code></li>
<li class="executed"><code>        return []</code></li>
<li class="missed"><code>    return {'navigation': get_navigation(root.url)}</code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>def get_initial_data(request):</code></li>
<li class="missed"><code>    if request.user:</code></li>
<li class="missed"><code>        initial = {'owner': '%s %s'%(request.user.first_name.capitalize(), request.user.last_name.capitalize()),</code></li>
<li class="ignored"><code>            'license': License.objects.get(name='BY-SA'),</code></li>
<li class="ignored"><code>            'author': request.user}</code></li>
<li class="missed"><code>        try:</code></li>
<li class="missed"><code>            profile = UserProfile.objects.get(user = request.user)</code></li>
<li class="missed"><code>            initial['owner_url'] = settings.SITE_URL + reverse('profiles_profile_detail',</code></li>
<li class="ignored"><code>                args=(),</code></li>
<li class="ignored"><code>                kwargs={'username': request.user.username})</code></li>
<li class="missed"><code>        except UserProfile.DoesNotExist:</code></li>
<li class="missed"><code>            pass</code></li>
<li class="ignored"><code>    else:</code></li>
<li class="missed"><code>        initial = {}</code></li>
<li class="missed"><code>    return initial</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>def process_image_form(request):</code></li>
<li class="missed"><code>    if request.method == 'POST': # If the form has been submitted...</code></li>
<li class="missed"><code>        form = ImageForm(request.POST, request.FILES, prefix='image') # A form bound to the POST data</code></li>
<li class="missed"><code>        if form.is_valid(): # All validation rules pass</code></li>
<li class="ignored"><code>            # Get the key</code></li>
<li class="missed"><code>            key = slugify(form.cleaned_data['title'])</code></li>
<li class="missed"><code>            try:</code></li>
<li class="missed"><code>                Image.objects.get(key=key)</code></li>
<li class="missed"><code>            except Image.DoesNotExist:</code></li>
<li class="missed"><code>                count = 1</code></li>
<li class="missed"><code>                while True:</code></li>
<li class="missed"><code>                    newkey = '%s-%s'%(key, count)</code></li>
<li class="missed"><code>                    try:</code></li>
<li class="missed"><code>                        Image.objects.get(key=newkey)</code></li>
<li class="missed"><code>                        count += 1</code></li>
<li class="missed"><code>                    except Image.DoesNotExist:</code></li>
<li class="missed"><code>                        key = newkey</code></li>
<li class="missed"><code>                        break</code></li>
<li class="missed"><code>            new_image = form.save(commit=False)</code></li>
<li class="missed"><code>            form.cleaned_data['image'] = new_image</code></li>
<li class="missed"><code>            new_image.key = key</code></li>
<li class="missed"><code>            if not request.user:</code></li>
<li class="missed"><code>                raise ValidationError, 'User must be logged in'</code></li>
<li class="ignored"><code>            else:</code></li>
<li class="missed"><code>                new_image.uploaded_by = request.user</code></li>
<li class="missed"><code>            new_image.save()</code></li>
<li class="missed"><code>            form.redirect_url = new_image.get_absolute_url()</code></li>
<li class="ignored"><code>    else:</code></li>
<li class="missed"><code>        form = ImageForm(initial=get_initial_data(request), prefix='image') # An unbound form</code></li>
<li class="missed"><code>    return form</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>REQUIRED_FIELDS = ('image', 'title', 'owner', 'text', 'teaser')</code></li>
<li class="executed"><code>@login_required</code></li>
<li class="ignored"><code>def edit_image(request):</code></li>
<li class="missed"><code>    imageform = process_image_form(request)</code></li>
<li class="missed"><code>    if hasattr(imageform, 'redirect_url'):</code></li>
<li class="missed"><code>        return HttpResponseRedirect(imageform.redirect_url)</code></li>
<li class="ignored"><code>    else:</code></li>
<li class="missed"><code>        return render_to_response('cms/edit_image.html',</code></li>
<li class="ignored"><code>            {'imageform': imageform, 'required': REQUIRED_FIELDS},</code></li>
<li class="ignored"><code>            context_instance=RequestContext(request)</code></li>
<li class="ignored"><code>            )</code></li>
<li class="ignored"><code></code></li>
<li class="executed"><code>@login_required</code></li>
<li class="executed"><code>def edit_post(request, post_id = None):</code></li>
<li class="missed"><code>    if request.method == 'POST': # If the form has been submitted...</code></li>
<li class="missed"><code>        postform = PostForm(request.POST, request.FILES, prefix='post') # A form bound to the POST data</code></li>
<li class="ignored"><code>        # check that the image form has been completed (look for a file path)</code></li>
<li class="missed"><code>        if request.FILES.has_key('image-image'):</code></li>
<li class="missed"><code>            imageform = process_image_form(request)</code></li>
<li class="ignored"><code>        else:</code></li>
<li class="missed"><code>            imageform = None</code></li>
<li class="missed"><code>        if postform.is_valid(): # All validation rules pass</code></li>
<li class="missed"><code>            new_post = postform.save(commit=False)</code></li>
<li class="missed"><code>            if imageform:</code></li>
<li class="missed"><code>                new_post.image = imageform.cleaned_data['image']</code></li>
<li class="ignored"><code>            else:</code></li>
<li class="missed"><code>                new_post.image = None</code></li>
<li class="missed"><code>            new_post.date_published =  datetime.date.today()</code></li>
<li class="missed"><code>            name = slugify(new_post.title)[:50]</code></li>
<li class="missed"><code>            try:</code></li>
<li class="missed"><code>                Post.objects.get(name=name)</code></li>
<li class="missed"><code>                count = 0</code></li>
<li class="missed"><code>                while True:</code></li>
<li class="missed"><code>                    count += 1</code></li>
<li class="missed"><code>                    newname = name[:(50 - 1 - len(str(count)))] + '-' + str(count)</code></li>
<li class="missed"><code>                    try:</code></li>
<li class="missed"><code>                        Post.objects.get(name=newname)</code></li>
<li class="missed"><code>                    except Post.DoesNotExist:</code></li>
<li class="missed"><code>                        name = newname</code></li>
<li class="missed"><code>            except Post.DoesNotExist:</code></li>
<li class="missed"><code>                pass</code></li>
<li class="missed"><code>            new_post.name = name</code></li>
<li class="missed"><code>            new_post.save()</code></li>
<li class="missed"><code>            return HttpResponseRedirect(new_post.get_absolute_url())</code></li>
<li class="ignored"><code>    else:</code></li>
<li class="missed"><code>        if not post_id:</code></li>
<li class="missed"><code>            postform = PostForm(prefix='post') # An unbound form</code></li>
<li class="missed"><code>            imageform = ImageForm(initial=get_initial_data(request), prefix='image') # An unbound form</code></li>
<li class="ignored"><code>        else:</code></li>
<li class="missed"><code>            post = get_object_or_404(Post, id=post_id)</code></li>
<li class="missed"><code>            postform = PostForm(post, prefix='post')</code></li>
<li class="missed"><code>            if not post.image:</code></li>
<li class="missed"><code>                imageform = ImageForm(initial=get_initial_data(request), prefix='image') # An unbound form</code></li>
<li class="ignored"><code>            else:</code></li>
<li class="missed"><code>                imageform = ImageForm(post.image, initial=get_initial_data(request), prefix='image') # An unbound form</code></li>
<li class="ignored"><code></code></li>
<li class="missed"><code>    return render_to_response('cms/edit_post.html', {'postform': postform, 'imageform': imageform, 'required': REQUIRED_FIELDS,},</code></li>
<li class="ignored"><code>        context_instance=RequestContext(request))</code></li>
  </ol>
</div>

<div class="nav">
  <a href="cms.models.html">cms.models</a> &lt;&lt;
  <a href="../index.html">index</a>
</div>

  </body>
</html>

